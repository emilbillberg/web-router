<script>

  /* @polymerBehavior */
  const WebReducer = (superClass) => {
    return class extends superClass {

      static get properties() {
        return {
          state: {
            type: Object,
          },
        };
      }

      constructor() {
        super();
        this.changeStateHandler = this.changeStateEvent.bind(this);
        this.getStateHandler = this.getStateEvent.bind(this);
        window.addEventListener('change-state', this.changeStateHandler, false);
        window.addEventListener('get-state', this.getStateHandler, false);
      }

      disconnectedCallback() {
        window.removeEventListener('change-state', this.changeStateListener);
        window.removeEventListener('get-state', this.getStateListener);
      }

      setInitialState(state) {
        if (this.state === undefined) {
          this.state = state;
        } else {
          console.error('Cannot set initial state multiple times');
        }
      }

      getStateEvent(event) {
        event.detail.state = this.state;
      }

      changeStateEvent(event) {
        const detail = event.detail;
        const type = detail.type;
        const data = detail.data;
        if (type === '__ROUTE_CHANGED') {
          this.state = Object.assign({}, this.state, { router: data });
        } else {
          const newState = this.reduceHandler(this.state, type, data);
          this.state = Object.assign({}, this.state, newState);
        }
        const customEvent = new CustomEvent('state-changed', { detail: { state: this.state } });
        window.dispatchEvent(customEvent);
      }

      reduceHandler() {
        console.error('A class that implement WebReducer must override reduceHandler function!');
      }
    };
  };

</script>